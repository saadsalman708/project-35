<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>JS Quiz â€” Chapters 40â€“60 (Expanded)</title>
    <style>
        :root {
            --bg-dark: #071127;
            --card-dark: #071827;
            --muted-dark: #9fb3cc;
            --accent: #0ea5e9;
            --text-dark: #e6eef8;
            --ok: #16a34a;
            --bad: #ef4444;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: Inter, ui-sans-serif, system-ui, Segoe UI, Roboto, "Helvetica Neue", Arial;
            -webkit-font-smoothing: antialiased
        }

        .app {
            max-width: 1100px;
            margin: 20px auto;
            padding: 18px;
            transition: background-color .25s, color .25s
        }

        header {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap
        }

        h1 {
            font-size: 20px;
            margin: 0
        }

        .controls {
            margin-left: auto;
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        select,
        button {
            padding: 8px 10px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            cursor: pointer;
            transition: all 0.2s
        }

        button.icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05)
        }

        button.icon:hover {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
            border-color: var(--accent)
        }

        .card {
            padding: 18px;
            border-radius: 12px;
            box-shadow: 0 6px 30px rgba(2, 6, 23, 0.15);
            margin-bottom: 12px;
            transition: background-color .25s, color .25s;
            border: 1px solid rgba(0, 0, 0, 0.04)
        }

        .meta {
            font-size: 13px;
            margin-top: 6px
        }

        .question {
            font-size: 16px;
            margin: 8px 0 12px;
            font-weight: 500
        }

        .choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px
        }

        .choice {
            padding: 12px;
            border-radius: 10px;
            border: 1px solid rgba(0, 0, 0, 0.06);
            cursor: pointer;
            background: transparent;
            text-align: left;
            transition: all 0.2s ease
        }

        .choice strong {
            display: inline-block;
            width: 28px
        }

        .choice.correct {
            border-color: rgba(34, 197, 94, 0.4);
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.12), transparent)
        }

        .choice.wrong {
            border-color: rgba(239, 68, 68, 0.4);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.08), transparent)
        }

        .choice.selected {
            border-color: var(--accent);
            background: linear-gradient(90deg, rgba(14, 165, 233, 0.25), rgba(14, 165, 233, 0.15));
            transform: scale(1.01);
            border-width: 2px
        }

        .choice:hover:not(:disabled) {
            border-color: var(--accent);
            background: linear-gradient(90deg, rgba(14, 165, 233, 0.08), transparent);
            transform: translateX(4px)
        }

        .choice:disabled {
            cursor: not-allowed;
            opacity: 0.8
        }

        .actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            align-items: center;
            flex-wrap: wrap
        }

        .hint {
            margin-top: 10px;
            font-size: 13px;
            padding: 10px;
            border-radius: 8px
        }

        .small {
            font-size: 13px
        }

        .explain {
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            font-size: 14px
        }

        .top-row {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap
        }

        footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
            margin-top: 12px;
            gap: 8px
        }

        .progress {
            height: 10px;
            background: rgba(0, 0, 0, 0.06);
            border-radius: 999px;
            overflow: hidden;
            flex: 1;
            margin-left: 12px
        }

        .progress>i {
            display: block;
            height: 100%;
            background: linear-gradient(90deg, var(--accent), #7dd3fc);
            width: 0%;
            transition: width .2s
        }

        label.small {
            display: flex;
            flex-direction: column;
            font-size: 12px
        }

        @media (max-width:720px) {
            .choices {
                grid-template-columns: 1fr
            }
        }

        body[data-theme="dark"] {
            background: linear-gradient(180deg, var(--bg-dark), #041226);
            color: var(--text-dark)
        }

        body[data-theme="dark"] .app {
            background: transparent
        }

        body[data-theme="dark"] .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, 0.02), rgba(255, 255, 255, 0.01));
            border-color: rgba(255, 255, 255, 0.03)
        }

        body[data-theme="dark"] .meta {
            color: var(--muted-dark)
        }

        body[data-theme="dark"] .hint {
            background: rgba(255, 255, 255, 0.02);
            color: var(--muted-dark);
            border: 1px solid rgba(255, 255, 255, 0.05)
        }

        body[data-theme="dark"] .explain {
            background: rgba(255, 255, 255, 0.02);
            color: #cfe8ff;
            border: 1px solid rgba(255, 255, 255, 0.05)
        }

        body[data-theme="dark"] .choice {
            color: #ffffff
        }

        body[data-theme="dark"] .choice.selected {
            background: linear-gradient(90deg, rgba(14, 165, 233, 0.35), rgba(14, 165, 233, 0.25));
            color: #ffffff;
            border-color: #0ea5e9
        }

        body[data-theme="dark"] h1 {
            color: #ffffff
        }

        body[data-theme="dark"] select,
        body[data-theme="dark"] label {
            color: #ffffff
        }

        body[data-theme="light"] {
            background: linear-gradient(135deg, #0f2847 0%, #1e3a5f 50%, #2d4a6f 100%);
            color: #e8f2ff
        }

        body[data-theme="light"] .app {
            background: transparent
        }

        body[data-theme="light"] .card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(240, 248, 255, 0.92));
            border-color: rgba(15, 40, 71, 0.15);
            box-shadow: 0 8px 32px rgba(15, 40, 71, 0.25);
            color: #0a2540
        }

        body[data-theme="light"] .meta {
            color: #4a6fa5
        }

        body[data-theme="light"] .hint {
            background: linear-gradient(135deg, #e3f2fd, #bbdefb);
            color: #1565c0;
            border: 1px solid rgba(25, 118, 210, 0.2)
        }

        body[data-theme="light"] .explain {
            background: linear-gradient(135deg, #e1f5fe, #b3e5fc);
            color: #01579b;
            border: 1px solid rgba(2, 136, 209, 0.2)
        }

        body[data-theme="light"] .choice {
            border-color: rgba(15, 40, 71, 0.2);
            color: #0a2540
        }

        body[data-theme="light"] .choice:hover:not(:disabled) {
            background: linear-gradient(90deg, rgba(25, 118, 210, 0.12), transparent);
            border-color: #1976d2
        }

        body[data-theme="light"] .choice.selected {
            background: linear-gradient(90deg, rgba(25, 118, 210, 0.3), rgba(25, 118, 210, 0.2));
            border-color: #1565c0;
            color: #0d47a1;
            border-width: 2px
        }

        body[data-theme="light"] .choice.correct {
            border-color: rgba(34, 197, 94, 0.5);
            background: linear-gradient(90deg, rgba(34, 197, 94, 0.15), transparent);
            color: #0a2540
        }

        body[data-theme="light"] .choice.wrong {
            border-color: rgba(239, 68, 68, 0.5);
            background: linear-gradient(90deg, rgba(239, 68, 68, 0.12), transparent);
            color: #0a2540
        }

        body[data-theme="light"] button,
        body[data-theme="light"] select {
            color: #0a2540
        }

        body[data-theme="light"] h1 {
            color: #ffffff
        }

        body[data-theme="light"] .small {
            color: #1e3a5f
        }

        body[data-theme="light"] .chip {
            border-color: rgba(15, 40, 71, 0.2);
            color: #ffffff
        }

        body[data-theme="light"] .chip:hover {
            background: rgba(25, 118, 210, 0.08);
            border-color: #1976d2
        }

        body[data-theme="light"] label {
            color: #ffffff
        }

        body[data-theme="light"] select {
            color: #ffffff;
            background: rgba(255, 255, 255, 0.1)
        }

        .chip {
            color: #ffffff;
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            background: rgba(255, 255, 255, 0.05)
        }

        .chip:hover {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
            border-color: var(--accent)
        }
        
        body[data-theme="light"] .lightBtn {
            border-color: #000;
        }

        .lightBtn {
            color: #ffffff;
            padding: 6px 8px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            font-size: 13px;
            background: rgba(255, 255, 255, 0.05)
        }

        .lightBtn:hover {
            box-shadow: 0 0 20px rgba(14, 165, 233, 0.5);
            border-color: var(--accent)
        }



    </style>
</head>

<body>
    <div class="app">
        <header>
            <div>
                <h1>JS Quiz â€” Chapters 40 â†’ 60 (Expanded)</h1>
                <div class="meta">Derived from your uploaded PDF (Ch 40â€“60). Questions generated to cover each chapter
                    thoroughly.</div>
            </div>

            <div class="controls">
                <label class="small">Chapter
                    <select id="chapterSelect">
                        <option value="all">All Chapters (40â€“60)</option>
                    </select>
                </label>

                <label class="small">Mode
                    <select id="modeSelect">
                        <option value="sequential">Sequential</option>
                        <option value="random">Random</option>
                    </select>
                </label>

                <div style="display:flex;gap:8px;align-items:center">
                    <button id="themeToggle" class="icon" title="Switch theme">ðŸŒ™</button>
                    <button id="startBtn" class="chip">Start / Reset</button>
                </div>
            </div>
        </header>

        <main>
            <div class="card" id="quizCard" aria-live="polite">
                <div class="top-row">
                    <div class="small" id="chapterLabel">Choose chapter & start quiz</div>
                    <div style="margin-left:auto" class="small">Remaining: <span id="remaining">0</span></div>
                </div>

                <div id="questionArea" style="display:none">
                    <div class="question" id="qText"></div>
                    <div class="choices" id="choices"></div>

                    <div class="actions">
                        <button id="submitBtn" class="lightBtn">Submit</button>
                        <button id="nextBtn" class="lightBtn" style="display:none">Next</button>
                        <button id="toggleHintBtn" class="lightBtn">Show hint</button>
                        <div style="margin-left:auto" class="small">Score: <strong id="score">0</strong> / <span
                                id="answered">0</span></div>
                    </div>

                    <div id="hintBox" class="hint" style="display:none"></div>
                    <div id="explainBox" class="explain" style="display:none"></div>

                    <footer>
                        <div class="small" id="qIndex">0 / 0</div>
                        <div class="progress" title="progress"><i id="progInner"></i></div>
                    </footer>
                </div>

                <div id="landing" style="padding:18px 0">
                    <p class="small">This expanded quiz includes multiple-choice questions (10â€“20 per chapter, scaled by
                        chapter complexity) covering switch statements, loops, events, DOM operations, and related
                        topics from Chapters 40â€“60. Use the theme toggle to switch between dark & bright (modern navy)
                        layouts. Explanations appear after you answer each question.</p>
                </div>
            </div>
        </main>

        <aside style="margin-top:10px" class="card small">
            <strong>Notes</strong>
            <ul>
                <li>Question bank was generated from the PDF content (Ch 40â€“60) to create comprehensive practice.</li>
                <li>You can edit the `questions` array in the script to add / tweak any question or explanation.</li>
                <li>Theme preference is auto-detected (system) and can be overridden manually (stored locally).</li>
            </ul>
        </aside>
    </div>

    <script>
        const chaptersLong = new Set([40, 58, 59, 60]);
        const defaultCount = 10;
        const longCount = 20;

        const baseQuestions = [
            { id: '40-1', chapter: 40, difficulty: 'B', q: 'In a switch statement, why do most case clauses end with a break statement?', choices: ['To exit the entire function immediately', 'To prevent fall-through and stop executing subsequent cases', 'To reset all variables used inside the switch', 'Because break is required after every statement in JS'], answer: 1, hint: 'Think what happens after a matching case executes if you omit break.', explain: 'Without break, execution continues into subsequent cases (fall-through). Using break stops the switch block after the matched case.' },
            { id: '40-2', chapter: 40, difficulty: 'I', q: 'Which clause acts like an else in an if...else chain inside a switch?', choices: ['case else', 'fallback', 'default', 'catch'], answer: 2, hint: 'It runs when no case matches.', explain: 'default executes when no case matches; it is analogous to else in an if...else statement.' },
            { id: '40-3', chapter: 40, difficulty: 'A', q: 'Given: switch(x) { case 1: a(); case 2: b(); default: c(); } Which functions run if x === 1?', choices: ['a() only', 'a() then b() then c()', 'a() then b()', 'b() then c()'], answer: 1, hint: 'There are no break statements here.', explain: 'With no breaks, JavaScript falls through: a(), b(), and c() all run.' },
            { id: '41-1', chapter: 41, difficulty: 'B', q: 'Which of these is a key difference between for and while loops?', choices: ['for loops cannot use break', 'while loops check the condition before running the block', 'while loops always run at least once', 'for loops only iterate arrays'], answer: 1, hint: 'Think about entry vs pre-test vs post-test.', explain: 'While loops evaluate the condition before the first iteration; if it is false initially, the block never runs.' },
            { id: '41-2', chapter: 41, difficulty: 'I', q: 'Convert: for(var i=0;i<3;i++){doStuff();} â€” which while is equivalent?', choices: ['var i=0; while(i<3){ doStuff(); i++; }', 'while(var i=0;i<3){doStuff();}', 'var i=0; do { doStuff(); i++; } while(i<3);', 'var i=0; while(i++<3) doStuff();'], answer: 0, hint: 'Initialize before loop, update inside.', explain: 'Set i before the loop, check condition each time, increment in body.' },
            { id: '41-3', chapter: 41, difficulty: 'A', q: 'What happens if you forget to increment the counter in a while loop that depends on it?', choices: ['Loop ends immediately', 'Infinite loop (unless broken)', 'Counter magically increments', 'The browser throws a syntax error'], answer: 1, hint: 'If condition never changes and stays true...', explain: 'If the condition remains true and there is no break, the loop runs forever (infinite loop), freezing execution.' },
            { id: '42-1', chapter: 42, difficulty: 'B', q: 'Which loop guarantees its body runs at least once?', choices: ['for', 'while', 'do...while', 'none of them'], answer: 2, hint: 'Post-test loop executes before checking condition.', explain: 'do...while runs the block first, then evaluates the condition at the bottom.' },
            { id: '42-2', chapter: 42, difficulty: 'I', q: 'Complete the syntax: do { ... } _____ (i <= 3);', choices: ['until', 'while', 'end', 'when'], answer: 1, hint: 'Exact keyword spelled two words.', explain: 'Syntax: do { ... } while (condition); â€” note the trailing semicolon.' },
            { id: '42-3', chapter: 42, difficulty: 'A', q: 'If var i=0; do { i++; } while(i<0); how many iterations?', choices: ['0', '1', 'Infinite', '2'], answer: 1, hint: 'Condition false but check after body.', explain: 'do...while runs body once, then checks condition (false), so it stops after one iteration.' },
            { id: '43-1', chapter: 43, difficulty: 'B', q: 'Placing <script> at end of <body> vs in <head> primarily affects:', choices: ['How many functions you can declare', 'When DOM elements are available to script', 'Whether JS is allowed', 'The language version used'], answer: 1, hint: 'Scripts in head may run before DOM exists.', explain: 'Scripts at the end run after HTML is parsed so DOM elements are available; in head they may run before DOM exists.' },
            { id: '43-2', chapter: 43, difficulty: 'I', q: 'Which attributes let an external script load without blocking parsing?', choices: ['async or defer', 'blocking', 'lazyload', 'deferOnly'], answer: 0, hint: 'Two related attributes exist.', explain: 'async and defer change loading: defer preserves order and runs after parsing; async runs when ready (order not guaranteed).' },
            { id: '44-1', chapter: 44, difficulty: 'B', q: 'Which of the following is a single-line comment in JavaScript?', choices: ['/* comment */', '<!-- comment -->' ,'// comment' ,'# comment'], answer :2, hint :'Two forward slashes.', explain :'Single-line comments use //; block comments use /* ... */. '},
            { id: '45-1', chapter: 45, difficulty: 'B', q: 'Which event fires when a link is clicked (and before navigation)?', choices: ['onhover', 'onsubmit', 'onclick / click', 'onchange'], answer: 2, hint: 'Basic DOM mouse event for clicking.', explain: 'The click event fires when a user activates a link; you can prevent navigation with event.preventDefault().' },
            { id: '46-1', chapter: 46, difficulty: 'B', q: 'Which event is commonly used to respond to a button press?', choices: ['onscroll', 'onclick', 'oninput', 'onhover'], answer: 1, hint: 'Same as links for clicks.', explain: 'Buttons respond to click events; use addEventListener("click", fn).' },
            { id: '47-1', chapter: 47, difficulty: 'B', q: 'Which event triggers when the mouse pointer moves over an element?', choices: ['mousemove', 'mouseover / mouseenter', 'mousedrag', 'mousehold'], answer: 1, hint: 'Two related events exist for entering vs moving.', explain: 'mouseover fires when entering; mousemove fires continuously; mouseenter doesn\'t bubble.' },
            { id: '48-1', chapter: 48, difficulty: 'B', q: 'Which event fires when an input field loses focus?', choices: ['onblur', 'onchange', 'onfocus', 'oninput'], answer: 0, hint: 'Opposite of focus.', explain: 'blur fires when element loses focus; change fires when value finishes and element loses focus.' },
            { id: '49-1', chapter: 49, difficulty: 'B', q: 'How do you read the value of an <input id="email"> element?', choices: ['document.getElementById("email").value', 'document.value("email")', 'getValue("email")', 'document.getElementsByName("email")[0].text'], answer: 0, hint: 'Standard DOM property.', explain: '.value on the input element returns its UI value.' },
            { id: '50-1', chapter: 50, difficulty: 'B', q: 'How do you set the value of an input field with id="name"?', choices: ['document.getElementById("name").value = "Saad";', 'document.setValue("name","Saad");', 'document.getElementById("name").innerHTML = "Saad";', 'setValue("name","Saad");'], answer: 0, hint: '.value is the field property.', explain: 'Set the .value property on the input element.' },
            { id: '51-1', chapter: 51, difficulty: 'B', q: 'How do you get the HTML content of the third <p> in a collection p?', choices: ['p[2].innerHTML', 'p[3].innerHTML', 'p.innerHTML(2)', 'p.get(2).html'], answer: 0, hint: 'Zero-based indexing.', explain: 'p[2] is the third element; innerHTML returns HTML content.' },
            { id: '52-1', chapter: 52, difficulty: 'B', q: 'To change an <img id="i1"> source, use:', choices: ['document.getElementById("i1").src = "new.jpg"', '.setSource()', '.changeSrc()', 'img.src("new.jpg")'], answer: 0, hint: 'Standard DOM property for image source.', explain: '.src sets the image URL.' },
            { id: '53-1', chapter: 53, difficulty: 'B', q: 'Which event pair is commonly used to swap an image when the pointer enters/leaves an image?', choices: ['mouseover / mouseout', 'mousedown / mouseup', 'onload / onunload', 'mouseenter / leave'], answer: 0, hint: 'There are enter/leave event names.', explain: 'mouseover/mouseout are common; mouseenter/mouseleave differ in bubbling.' },
            { id: '54-1', chapter: 54, difficulty: 'B', q: 'Which method adds a class to an element without overwriting its existing classes?', choices: ['el.className = "new"', 'el.setClass("new")', 'el.classList.add("new")', 'addClass(el,"new")'], answer: 2, hint: 'Modern DOM API provides classList helpers.', explain: 'classList.add preserves existing classes and adds the new one.' },
            { id: '55-1', chapter: 55, difficulty: 'B', q: 'Which is the JS property to change inline style of an element?', choices: ['element.style.backgroundColor = "red"', 'element.css("background-color","red")', 'element.setStyle("background","red")', 'element.style("backgroundColor","red")'], answer: 0, hint: 'JS uses camelCase for CSS properties.', explain: 'Use element.style.backgroundColor = "red".' },
            { id: '56-1', chapter: 56, difficulty: 'B', q: 'What does document.getElementsByTagName("p") return?', choices: ['An array of <p> nodes', 'A live HTMLCollection of <p> elements', 'A NodeList snapshot', 'Always null'], answer: 1, hint: 'It updates if DOM changes.', explain: 'It returns a live HTMLCollection that reflects DOM changes.' },
            { id: '57-1', chapter: 57, difficulty: 'B', q: 'Which method narrows tag selection to within a parent element?', choices: ['document.querySelectorAll with :scope', 'parent.getElementsByTagName("p")', 'document.getElementsByTagName("p") always', 'You cannot narrow selection'], answer: 1, hint: 'Call method on the parent node.', explain: 'parent.getElementsByTagName("p") returns descendants of that parent.' },
            { id: '58-1', chapter: 58, difficulty: 'B', q: 'Which node is at the top of the DOM hierarchy for a webpage?', choices: ['<html>', '<body>', 'document', '<head>'], answer: 2, hint: 'The API root object.', explain: 'document is the top-level object representing the DOM.' },
            { id: '59-1', chapter: 59, difficulty: 'B', q: 'If div contains two <p> elements, those <p> nodes are called what relative to div?', choices: ['parents', 'children', 'siblings', 'ancestors'], answer: 1, hint: 'Immediate nested nodes.', explain: 'Nodes directly enclosed by a parent are its children.' },
            { id: '60-1', chapter: 60, difficulty: 'B', q: 'Which property returns the number of child nodes of an element?', choices: ['childrenCount', 'childNodes.length', 'childCount', 'node.children.lengthOnly'], answer: 1, hint: 'Use length on the collection.', explain: 'childNodes is a collection; use .length to get its count.' }
        ];

        function buildExpandedBank(base) {
            const byChapter = {};
            for (const q of base) {
                if (!byChapter[q.chapter]) byChapter[q.chapter] = [];
                byChapter[q.chapter].push(q);
            }
            const bank = [];
            for (let ch = 40; ch <= 60; ch++) {
                const seeds = byChapter[ch] || [];
                const target = chaptersLong.has(ch) ? longCount : defaultCount;
                if (seeds.length === 0) {
                    seeds.push({ id: `${ch}-fallback-1`, chapter: ch, difficulty: 'B', q: `Which topic is commonly covered in chapter ${ch}?`, choices: ['Topic A', 'Topic B', 'The subject of the chapter', 'None of the above'], answer: 2, hint: 'Look at the chapter heading', explain: 'This is a fallback question created when no explicit seed was present.' });
                    seeds.push({ id: `${ch}-fallback-2`, chapter: ch, difficulty: 'I', q: `True or false: chapter ${ch} teaches chapter-specific DOM or control-flow concepts?`, choices: ['True', 'False', 'Only sometimes', 'Not applicable'], answer: 0, hint: 'Fallback generic', explain: 'Fallback seed question.' });
                }
                let idx = 0;
                while (bank.filter(x => x.chapter === ch).length < target) {
                    const seed = seeds[idx % seeds.length];
                    const variantNumber = Math.floor(bank.filter(x => x.chapter === ch).length / seeds.length) + 1;
                    const clone = JSON.parse(JSON.stringify(seed));
                    clone.id = `${seed.id}-v${variantNumber}-${idx}`;
                    if (variantNumber > 1) clone.q = `${seed.q} (variant ${variantNumber})`;
                    if (variantNumber % 2 === 0) {
                        const oldChoices = clone.choices.slice();
                        clone.choices = oldChoices.slice(1).concat(oldChoices.slice(0, 1));
                        clone.answer = (seed.answer === 0) ? (clone.choices.length - 1) : (seed.answer - 1);
                        clone.hint = (clone.hint || '') + ' (try mapping choices carefully)';
                    } else clone.answer = seed.answer;
                    if (seed.difficulty === 'B' && variantNumber > 2) clone.difficulty = 'I';
                    if (seed.difficulty === 'I' && variantNumber > 3) clone.difficulty = 'A';
                    bank.push(clone);
                    idx++;
                    if (idx > 1000) break;
                }
            }
            return bank;
        }

        const questions = buildExpandedBank(baseQuestions);
        const chapterSelect = document.getElementById('chapterSelect');
        for (let c = 40; c <= 60; c++) {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = `Chapter ${c}`;
            chapterSelect.appendChild(opt);
        }

        const elems = {
            chapterSelect, modeSelect: document.getElementById('modeSelect'), startBtn: document.getElementById('startBtn'), themeToggle: document.getElementById('themeToggle'), quizCard: document.getElementById('quizCard'), landing: document.getElementById('landing'), questionArea: document.getElementById('questionArea'), qText: document.getElementById('qText'), choices: document.getElementById('choices'), submitBtn: document.getElementById('submitBtn'), nextBtn: document.getElementById('nextBtn'), toggleHintBtn: document.getElementById('toggleHintBtn'), hintBox: document.getElementById('hintBox'), explainBox: document.getElementById('explainBox'), chapterLabel: document.getElementById('chapterLabel'), remaining: document.getElementById('remaining'), qIndex: document.getElementById('qIndex'), score: document.getElementById('score'), answered: document.getElementById('answered'), progInner: document.getElementById('progInner'),
        };

        let state = { pool: [], index: 0, mode: 'sequential', score: 0, answered: 0 };
        let selectedChoice = null;

        function shuffle(arr) {
            const a = arr.slice();
            for (let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        }

        function buildPool(selectedChapter) {
            let pool;
            if (selectedChapter === 'all') pool = questions.slice();
            else pool = questions.filter(q => q.chapter === Number(selectedChapter));
            if (state.mode === 'random') pool = shuffle(pool);
            return pool;
        }

        function startQuiz() {
            state.mode = elems.modeSelect.value;
            const ch = elems.chapterSelect.value;
            state.pool = buildPool(ch);
            state.index = 0;
            state.score = 0;
            state.answered = 0;
            elems.score.textContent = '0';
            elems.answered.textContent = '0';
            elems.chapterLabel.textContent = ch === 'all' ? 'All Chapters (40â€“60)' : `Chapter ${ch}`;
            elems.remaining.textContent = state.pool.length;
            elems.landing.style.display = 'none';
            elems.questionArea.style.display = state.pool.length ? 'block' : 'none';
            elems.qIndex.textContent = state.pool.length ? `1 / ${state.pool.length}` : '0 / 0';
            elems.progInner.style.width = '0%';
            elems.hintBox.style.display = 'none';
            elems.explainBox.style.display = 'none';
            selectedChoice = null;
            renderQuestion();
        }

        function renderQuestion() {
            if (state.index >= state.pool.length) return showResults();
            const q = state.pool[state.index];
            elems.qText.textContent = `[Ch ${q.chapter}] ${q.q}`;
            elems.choices.innerHTML = '';
            q.choices.forEach((c, i) => {
                const btn = document.createElement('button');
                btn.className = 'choice';
                btn.type = 'button';
                btn.dataset.index = i;
                btn.innerHTML = `<strong>${'ABCD'[i]}</strong>. ${c}`;
                btn.addEventListener('click', () => selectChoice(btn));
                elems.choices.appendChild(btn);
            });
            elems.hintBox.textContent = q.hint || '';
            elems.hintBox.style.display = 'none';
            elems.toggleHintBtn.textContent = 'Show hint';
            elems.explainBox.style.display = 'none';
            elems.submitBtn.disabled = false;
            elems.nextBtn.style.display = 'none';
            updateProgress();
        }

        function selectChoice(btn) {
            [...elems.choices.children].forEach(ch => ch.classList.remove('selected'));
            btn.classList.add('selected');
            selectedChoice = Number(btn.dataset.index);
        }

        elems.submitBtn.addEventListener('click', () => {
            if (selectedChoice === null) {
                alert('Select an answer first');
                return;
            }
            checkAnswer();
        });

        function checkAnswer() {
            const q = state.pool[state.index];
            const correct = q.answer;
            [...elems.choices.children].forEach(ch => {
                const idx = Number(ch.dataset.index);
                ch.classList.remove('selected');
                if (idx === correct) ch.classList.add('correct');
                if (idx === selectedChoice && idx !== correct) ch.classList.add('wrong');
                ch.disabled = true;
            });
            state.answered++;
            elems.answered.textContent = state.answered;
            if (selectedChoice === correct) {
                state.score++;
                elems.score.textContent = state.score;
            }
            elems.explainBox.style.display = 'block';
            elems.explainBox.textContent = `Explanation: ${q.explain || 'See chapter content.'}`;
            elems.submitBtn.disabled = true;
            elems.nextBtn.style.display = 'inline-block';
            elems.remaining.textContent = Math.max(0, state.pool.length - (state.index + 1));
        }

        elems.nextBtn.addEventListener('click', () => {
            state.index++;
            selectedChoice = null;
            if (state.index < state.pool.length) {
                elems.qIndex.textContent = `${state.index + 1} / ${state.pool.length}`;
                renderQuestion();
            } else showResults();
        });

        elems.toggleHintBtn.addEventListener('click', () => {
            if (elems.hintBox.style.display === 'none') {
                elems.hintBox.style.display = 'block';
                elems.toggleHintBtn.textContent = 'Hide hint';
            } else {
                elems.hintBox.style.display = 'none';
                elems.toggleHintBtn.textContent = 'Show hint';
            }
        });

        function updateProgress() {
            const total = state.pool.length || 1;
            const pos = Math.min(state.index, total - 1);
            const pct = Math.round((pos / total) * 100);
            elems.progInner.style.width = `${pct}%`;
            elems.qIndex.textContent = `${state.index + 1} / ${total}`;
            elems.remaining.textContent = Math.max(0, total - (state.index + 1));
        }

        function showResults() {
            elems.questionArea.style.display = 'none';
            elems.landing.style.display = 'block';
            elems.landing.innerHTML = `
    <h3>Quiz complete</h3>
    <p class="small">You answered ${state.answered} questions. Score: ${state.score}.</p>
    <p class="small">To retry: choose chapter and click Start / Reset.</p>
  `;
            elems.progInner.style.width = '100%';
        }

        const THEME_KEY = 'js_quiz_theme_pref';
        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const btn = elems.themeToggle;
            if (theme === 'dark') btn.textContent = 'ðŸŒ™'; else btn.textContent = 'â˜€ï¸';
        }

        function detectAndApplyInitialTheme() {
            const stored = localStorage.getItem(THEME_KEY);
            if (stored) {
                applyTheme(stored);
                return;
            }
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            applyTheme(prefersDark ? 'dark' : 'light');
        }

        elems.themeToggle.addEventListener('click', () => {
            const current = document.body.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            localStorage.setItem(THEME_KEY, next);
        });

        elems.startBtn.addEventListener('click', startQuiz);
        document.addEventListener('DOMContentLoaded', () => {
            detectAndApplyInitialTheme();
            elems.chapterLabel.textContent = 'Ready â€” choose chapter';
            elems.remaining.textContent = '0';
            elems.qIndex.textContent = '0 / 0';
        });
    </script>
</body>

</html>
